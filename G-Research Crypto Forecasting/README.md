# 🚀 G-Research Crypto Forecasting

: 머신러닝 전문 지식을 활용하여 실제 암호화폐 시장 데이터 예측하기

### 📚 참고 자료

<aside>
💡

대회: https://www.kaggle.com/competitions/g-research-crypto-forecasting

참고한 노트북: 

https://www.kaggle.com/code/cstein06/tutorial-to-the-g-research-crypto-competition#Prediction-targets-and-evaluation

https://www.kaggle.com/code/iamleonie/time-series-interpreting-acf-and-pacf

</aside>

### **📌 대회 정리**

| 주제 | 14개 암호화폐의 단기 수익률 예측 |
| --- | --- |
| 주최 | G-Research, Cambridge Spark |
| 총 상금 | 총 $120,000   
1등 - $50,000 |
| 문제 유형 | 회귀(Regression) / 시계열 예측(Time-Series Forecasting) |
| 데이터 타입 |  |
| 평가 지표 | 가중치가 적용된 피어슨 상관계수 (Weighted Pearson Correlation) |
| 대회 시작 일시 | 2021년 11월 2일 |
| 대회 종료 일시 | 2022년 5월 3일 (우승자 발표) |
| 대회 참가 팀 | 약 1,946여  |

# 1️⃣ 대회 개요

매일 400억 달러 이상의 암호화폐가 거래되며, 이는 투자와 투기의 인기 있는 자산이다. 하지만 높은 변동성으로 인해 가격 예측이 매우 어려운 상황이다. 

14개 암호화폐의 단기 수익률 예측 모델 개발이 목표

### 🔑 주요 도전 과제

- 수많은 거래자가 동시에 거래를 진행하기 때문에 대부분의 신호가 일시적 → 지속적이고 의미있는 신호를 찾는 것이 어려움
- 과적합(Overfitting) 위험 → 지속적인 초과 수익(Alpha)를 찾기 어려움
- 비정상성 데이터(Non-Stationary) → 시장 환경이 계속 변화(변동성) 고려

### **⚒️ 데이터**

- 2018년 이후 고빈도 시장 데이터 제공

### ⛑️ 주의 사항

- Python 시계열 API를 사용해 모델이 시간을 앞지르지 않도록 해야 한다.

```
import gresearch_crypto
env = gresearch_crypto.make_env()   # initialize the environment
iter_test = env.iter_test()    # an iterator which loops over the test set and sample submission
for (test_df, sample_prediction_df) in iter_test:
    sample_prediction_df['Target'] = 0  # make your predictions here
    env.predict(sample_prediction_df)   # register your predictions
```

→ 이 API는 테스트 데이터와 예측 데이터가 시간 순서대로 처리되도록 설계. 모델은 과거 및 현재 데이터를 기반으로만 학습하고 예측하며 평가 시점 이후의 데이터를 참조하지 못하도록 제한

### 💡 평가 지표

- 가중치가 적용된 피어슨 상관계수(Weighted Pearson Correlation)
    
    → 피어슨 상관계수: 두 변수 간의 선형 관계를 측정하는 값 (+1에 가까우면 강한 양의 상관관계, -1에 가까우면 강한 음의 상관관계) 
    

### 📒 가중치된 피어슨 상관계수를 평가지표로 사용하는 이유

- ~~암호화폐 시장의 특성상 변동성이 높고, 데이터의 중요도가 시점별로 다름~~
- ~~거래량이 많은 시점의 데이터가 더 신뢰할 만한 정보를 포함할 가능성이 큼~~
- ~~단순 평균보다 가중치를 반영하면 모델의 예측력을 더욱 정밀하게 평가 가능~~
- 모든 암호화폐가 동일한 영향력을 갖지 않음
- 데이터셋에서 암호화폐별 가중치(Weight)가 제공됨 → 주요 자산일수록 평가 시 더 높은 영향력을 가짐
- 이를 위해 `asset_details.csv`에서 각 암호화폐별 가중치가 제공됨

![image.png](image.png)

# 2️⃣ 데이터 소개

| **timestamp** | Unix 타임스탬프 (1970-01-01 00:00:00 UTC 이후 초 단위 경과 시간), 60초 단위 데이터 |
| --- | --- |
| **Asset_ID** | 암호화폐를 식별하는 ID (예: 1 = Bitcoin) |
| **Count** | 해당 분(minute) 동안의 총 거래 횟수 |
| **Open** | 해당 분의 시작(개장) 가격 (USD) |
| **High** | 해당 분 동안의 최고 가격 (USD) |
| **Low** | 해당 분 동안의 최저 가격 (USD) |
| **Close** | 해당 분의 종료(종가) 가격 (USD) |
| **Volume** | 해당 분 동안의 매수/매도된 자산 수량 (USD 기준)  |
| **VWAP** | 거래량 가중 평균 가격 (Volumne Weighted Average Price) |
| **Target** | 15분 후 예상 로그 수익률 (Residual log-returns)  |

📌 추가 데이터: `asset_details.csv` 파일에는 **Asset_ID**와 암호화폐 종류 매핑 정보 및 각 자산의 중요도를 나타내는 가중치(Weight)가 포함됨

# 3️⃣ 튜토리얼

## 📈 **캔들스틱 차트 (Candlestick Charts)**

- `Open`, `High`, `Low`, `Close` 데이터를 시각화하는 차트 형태로 주로 기술적 분석에 사용됨

### 차트 구성 요소

1. **바디(Body) → 시가(Open)와 종가(Close) 간 가격 범위**
    - 초록색: 종가가 시가보다 높음 (가격 상승 = Bullish)
    - 빨강색: 종가가 시가보다 낮음 (가격 하락 = Bearish)
2. **윗꼬리와 아랫꼬리(Wicks)** 
    - 해당 시간대 동안의 최고가(High)와 최저가(Low)를 보여줌
    - 꼬리의 길이는 변동성을 나타냄

![image.png](image%201.png)

---

주어진 분 동안 누락된 자산 데이터는 NaN이 아니라 해당 행이 없는 것으로 표시됩니다. 연속된 행 사이의 타임스탬프 차이를 확인하여 누락된 데이터가 있는지 확인할 수 있습니다.

가장 빈번하게 나타나는 5개의 시간 간격과 그 빈도를 출력합니다. →  데이터프레임의 인덱스(시간 정보)에서 연속된 시간 간격(예: 분 또는 초 단위 차이)의 분포를 확인하려는 목적

데이터에 많은 간격이 있음을 알 수 있습니다. 대부분의 시계열 모델로 작업하려면 데이터를 시간 간격이 없는 형식으로 사전 처리해야 합니다. 공백을 채우기 위해 .reindex() 메서드를 사용하여 공백을 이전의 유효한 값으로 채우는 순방향 채우기를 사용할 수 있습니다.

데이터 프레임의 인덱스를 연속적인 60초 간격 시계열 데이터로 변환한다. 

새로 생성된 인덱스에 기존 데이터가 없는 경우, 이전 값을 채워넣는다. 

결과적으로, 데이터프레임의 인덱스가 시간 단위로 균일한 간격을 가지게 된다. 특정 시간대에 데이터가 누락된 경우도 보완된다. 

첫 번째 그래프는 BTC의 종가를, 두 번째 그래프는 ETH의 종가를 보여준다. 

![image.png](image%202.png)

⇒ 두 자산 간의 잠재적 상관관계를 시각적으로 확인할 수 있으며, 상승과 하락이 거의 동시에 일어날 수 있음을 확인 

---

### 1. 자산 수익률(Returns)

- 자산의 가격 변화를 분석하기 위해 가격 차이를 계산
- 하지만 자산마다 가격 규모가 다르기 때문에, 단순 가격 차이만으로는 비교가 어려움
- 이를 해결하기 위해 ‘가격의 백분율 변화(수익률, Returns)’를 계산

### 2. 로그 수익률(Log Returns)

- 시간에 따라 가산적
- 반면, 일반 수익률은 -100% 이하로 내려갈 수 없으나, 로그 수익률은 제한이 없다
- 로그 수익률 계산
    - 두 연속적인 가격의 비율에 대해 로그 값을 취해 계산
    - 첫 번째 값은 이전 데이터가 없기 때문에 로그 수익률이 비어 있게 되며, 이를 삭제

비트코인(lret_btc)과 이더리움(lret_eth) 로그 수익률 시계열이 같은 그래프에 나타납니다.

![image.png](image%203.png)

→ 자산 간의 상관관계가 높지만 가변적이라는 점에 주목하자. 상관관계가 시간에 따라 상승과 하락을 반복하는 흐름을 보인다. 이는 두 자산 간의 관계가 일정하지 않고 동적이라는 것을 의미한다. → 비정상성(Non-stationarity) 특징을 보여줌 

- 상관관계가 높을 때: 두 자산의 움직임이 비슷함(강한 동조화)
- 상관관계가 낮을 때: 두 자산이 독립적으로 움직임

⇒ 즉 상관관계가 일정하지 않으므로, BTC와 ETH가 항상 동시에 움직이지는 않는다는 점을 알 수 있음 

모든 자산의 로그 수익률을 포함시키는 과정은 다음 두 가지를 조합한 결과

1. 자산별 개별 처리: 각 자산 데이터를 필터링하고 로그 수익률을 계산
2. 데이터 병합: 모든 자산의 결과를 `all_assets_2021` 데이터 프레임에 합치면서, 동일한 시간 축을 공유하게 정렬

![image.png](image%204.png)

![image.png](image%205.png)

목표: 자산 가격의 근시일 내 수익률 예측

로그 수익률 (미래 16분 후의 자산 가격) / (미래 1분 후의 자산 가격) 

시장 신호 제거 및 Target 계산

- 왜 시장 신호를 제거하는가?
    - 암호화폐 자산의 수익률은 전체 시장과 높은 상관관계를 가진다.
    - 개별 자산의 수익률 예측 능력을 평가하기 위해, 시장의 영향을 제거한 개별 자산의 순수 수익률을 타겟으로 설정
    

결과적으로, BTC와  ETH를 각각 계산한 단순 회귀 모델보다 다중 출력 회귀 모델(Multi-Output Regression, 입력 데이터를 기반으로 여러 타켓 변수를 동시에 예측)
